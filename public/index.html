<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Xayz AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap');
        
        /* === GLOBAL & ANIMATIONS === */
        body { transition: background-color 0.4s ease, color 0.4s ease; font-family: 'Outfit', sans-serif; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* === AUTH PAGE (XAYZ BRANDING) === */
        .auth-bg {
            background: radial-gradient(circle at top right, #4f46e5 0%, #0f172a 40%, #000000 100%);
            color: white;
        }
        .auth-glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .auth-input {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s;
        }
        .auth-input:focus {
            border-color: #6366f1;
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.3);
            background: rgba(15, 23, 42, 0.9);
        }

        /* === THEME: GEMINI (GOOGLE STYLE) === */
        body.theme-gemini { background-color: #131314; color: white; font-family: 'Outfit', sans-serif; }
        .theme-gemini .gradient-text {
            background: linear-gradient(74deg, #4285f4 0, #9b72cb 9%, #d96570 20%, #131314 24%, #131314 35%, #4285f4 40%, #9b72cb 50%, #d96570 60%, #131314 65%, #131314 100%);
            background-size: 400% 100%; -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; display: inline-block;
        }
        .theme-gemini .sidebar-bg { background-color: #1e1f20; border-right: none; }
        .theme-gemini .sidebar-active { background-color: #004a77; color: #c2e7ff; }
        .theme-gemini .input-box { background-color: #1e1f20; border-radius: 28px; border: 1px solid #444746; }
        .theme-gemini .input-box:focus-within { background-color: #28292a; border-color: #c2e7ff; }
        .theme-gemini .suggestion-card { background-color: #1e1f20; border-radius: 12px; border: none; }
        .theme-gemini .suggestion-card:hover { background-color: #333537; }
        .theme-gemini .user-msg { background-color: #28292a; border-radius: 20px; }

        /* === THEME: CHATGPT (OPENAI STYLE) === */
        body.theme-chatgpt { background-color: #343541; color: #ececf1; }
        .theme-chatgpt .gradient-text { background: none; -webkit-text-fill-color: white; color: white; }
        .theme-chatgpt .sidebar-bg { background-color: #202123; border-right: 1px solid #4d4d4f; }
        .theme-chatgpt .sidebar-active { background-color: #343541; color: white; border-radius: 6px; }
        .theme-chatgpt .sidebar-item { border-radius: 6px; }
        .theme-chatgpt .input-box { background-color: #40414f; border-radius: 12px; border: 1px solid #565869; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .theme-chatgpt .input-box:focus-within { border-color: #10a37f; }
        .theme-chatgpt .suggestion-card { background-color: #40414f; border: 1px solid #565869; border-radius: 6px; }
        .theme-chatgpt .suggestion-card:hover { background-color: #2a2b32; }
        .theme-chatgpt .user-msg { background-color: #444654; border-radius: 6px; }
        .theme-chatgpt #sendBtn { background-color: #19c37d !important; border-radius: 6px; }
        
        /* === THEME: BING (MICROSOFT STYLE) === */
        body.theme-bing { background-color: #f0f3f9; color: #1a1a1a; }
        .theme-bing #mainApp { background-color: #fff; } 
        .theme-bing .gradient-text { background: none; -webkit-text-fill-color: #005a9e; color: #005a9e; }
        .theme-bing .sidebar-bg { background-color: #f0f3f9; border-right: 1px solid #e0e0e0; }
        .theme-bing .sidebar-active { background-color: #fff; color: #0078d4; box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-weight: 600; }
        .theme-bing .sidebar-item { color: #444; }
        .theme-bing .input-box { background-color: #fff; border-radius: 20px; border: 1px solid #0078d4; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .theme-bing .suggestion-card { background-color: #fff; border: 1px solid #e0e0e0; border-radius: 8px; color: #333; }
        .theme-bing .suggestion-card:hover { background-color: #f0f3f9; border-color: #0078d4; }
        .theme-bing .user-msg { background-color: #dbeafe; color: #005a9e; border-radius: 12px; }
        .theme-bing .ai-msg { color: #333; }
        .theme-bing #sendBtn { background-color: #0078d4 !important; border-radius: 50%; color: white; }

        /* === THEME: BLACKBOX (CODING STYLE) === */
        body.theme-blackbox { font-family: 'JetBrains Mono', monospace; background-color: #050505; color: #00ff41; }
        .theme-blackbox .gradient-text { background: none; -webkit-text-fill-color: #00ff41; text-shadow: 0 0 10px rgba(0,255,65,0.4); }
        .theme-blackbox .sidebar-bg { background-color: #0a0a0a; border-right: 1px solid #1a1a1a; }
        .theme-blackbox .sidebar-active { background-color: #111; color: #00ff41; border-left: 3px solid #00ff41; border-radius: 0; }
        .theme-blackbox .sidebar-item { border-radius: 0; font-family: 'JetBrains Mono', monospace; }
        .theme-blackbox .input-box { background-color: #0a0a0a; border-radius: 0; border: 1px solid #333; }
        .theme-blackbox .input-box:focus-within { border-color: #00ff41; box-shadow: 0 0 15px rgba(0,255,0,0.1); }
        .theme-blackbox .suggestion-card { background-color: #0a0a0a; border: 1px solid #333; border-radius: 0; }
        .theme-blackbox .suggestion-card:hover { border-color: #00ff41; background: #0f0f0f; }
        .theme-blackbox .user-msg { background-color: #111; border: 1px solid #333; border-radius: 0; color: #00ff41; }
        .theme-blackbox #sendBtn { background-color: #111 !important; border: 1px solid #333; border-radius: 0; color: #00ff41; }
        .theme-blackbox .ai-msg { font-family: 'JetBrains Mono', monospace; color: #ddd; }

        /* === SHARED STYLES === */
        .sidebar-item { padding: 12px 16px; margin-bottom: 4px; transition: all 0.2s; cursor: pointer; display: flex; align-items: center; gap: 12px; font-size: 0.9rem; }
        .sidebar-inactive { color: inherit; opacity: 0.7; }
        .sidebar-inactive:hover { opacity: 1; background-color: rgba(255,255,255,0.05); }
        
        pre { position: relative; padding: 0; border-radius: 8px; overflow: hidden; margin: 10px 0; background: #0d0d0d; border: 1px solid #333; }
        code { font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; }
        .code-header { display: flex; justify-content: space-between; align-items: center; background: #2d2d2d; padding: 6px 12px; font-size: 0.75rem; color: #bbb; }
        .copy-btn { background: transparent; border: none; color: #fff; cursor: pointer; font-size: 0.75rem; display: flex; align-items: center; gap: 4px; opacity: 0.7; transition: opacity 0.2s; }
        .copy-btn:hover { opacity: 1; }
        pre code { display: block; padding: 12px; overflow-x: auto; color: #e0e0e0; }

        /* LOADER */
        .gemini-loader { height: 4px; width: 100%; background: linear-gradient(90deg, #4285f4, #9b72cb, #d96570); background-size: 200% 100%; animation: loading 2s infinite linear; border-radius: 4px; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="auth-bg h-[100dvh] w-full overflow-hidden flex flex-col">

    <div id="authPage" class="absolute inset-0 z-[100] flex items-center justify-center p-4">
        <div class="auth-glass p-8 w-full max-w-sm rounded-2xl relative overflow-hidden">
            <div class="absolute -top-10 -left-10 w-32 h-32 bg-blue-500 rounded-full blur-[50px] opacity-40"></div>
            <div class="absolute bottom-0 right-0 w-40 h-40 bg-purple-600 rounded-full blur-[60px] opacity-30"></div>

            <div class="relative z-10 text-center">
                <h1 class="text-4xl font-bold mb-2 text-white tracking-tight drop-shadow-lg">Xayz AI</h1>
                <p class="text-blue-200 text-sm mb-8 tracking-wider uppercase">Next Gen Intelligence</p>
                
                <form id="loginForm" onsubmit="handleLogin(event)" class="text-left space-y-5 animate-[fadeIn_0.5s]">
                    <div class="space-y-1">
                        <label class="text-xs text-gray-300 ml-1">Username</label>
                        <input type="text" id="loginUser" class="w-full p-3 rounded-xl auth-input outline-none" placeholder="Masukan username" required>
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs text-gray-300 ml-1">Password</label>
                        <input type="password" id="loginPass" class="w-full p-3 rounded-xl auth-input outline-none" placeholder="Masukan password" required>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-indigo-600/30 transition transform hover:scale-[1.02]">MASUK</button>
                    <p class="mt-6 text-center text-sm text-gray-400">Belum punya akun? <span class="text-indigo-400 font-bold cursor-pointer hover:underline" onclick="toggleAuth('register')">Daftar</span></p>
                </form>

                <form id="registerForm" onsubmit="handleRegister(event)" class="hidden text-left space-y-4 mt-4 animate-[fadeIn_0.5s]">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="regFirst" placeholder="Nama Depan" class="p-3 rounded-xl auth-input outline-none" required>
                        <input type="text" id="regLast" placeholder="Nama Belakang" class="p-3 rounded-xl auth-input outline-none" required>
                    </div>
                    <input type="text" id="regUser" placeholder="Username" class="w-full p-3 rounded-xl auth-input outline-none" required>
                    <input type="password" id="regPass" placeholder="Password" class="w-full p-3 rounded-xl auth-input outline-none" required>
                    <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-emerald-600/30 transition">BUAT AKUN</button>
                    <p class="mt-4 text-center text-sm text-gray-400">Sudah punya akun? <span class="text-indigo-400 font-bold cursor-pointer hover:underline" onclick="toggleAuth('login')">Login</span></p>
                </form>
            </div>
        </div>
    </div>

    <div id="mainApp" class="hidden h-full flex relative">
        
        <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden"></div>
        <aside id="sidebar" class="sidebar-bg fixed inset-y-0 left-0 z-50 w-72 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 flex flex-col h-full pt-4">
            <div class="px-6 mb-6 flex justify-between items-center">
                <div class="text-xl font-bold tracking-wide flex items-center gap-2">
                    <i class="fa-solid fa-robot"></i> Xayz AI
                </div>
                <button onclick="toggleSidebar()" class="md:hidden text-gray-400"><i class="fa-solid fa-bars"></i></button>
            </div>

            <nav class="flex-1 px-3 overflow-y-auto">
                <div class="text-xs font-semibold opacity-50 mb-2 px-2 mt-2 uppercase tracking-wider">Chat Models</div>
                <div onclick="switchModel('gemini')" class="sidebar-item sidebar-active">
                    <i class="fa-solid fa-star"></i> Gemini Flash
                </div>
                <div onclick="switchModel('chatgpt')" class="sidebar-item sidebar-inactive">
                    <i class="fa-solid fa-bolt"></i> ChatGPT
                </div>
                <div onclick="switchModel('bing')" class="sidebar-item sidebar-inactive">
                    <i class="fa-brands fa-microsoft"></i> Bing AI
                </div>
                <div onclick="switchModel('blackbox')" class="sidebar-item sidebar-inactive">
                    <i class="fa-solid fa-code"></i> Blackbox
                </div>
                
                <div class="my-4 border-t border-white/10"></div>
                <div class="text-xs font-semibold opacity-50 mb-2 px-2 uppercase tracking-wider">Creative Studio</div>
                <div onclick="switchModel('img-openai')" class="sidebar-item sidebar-inactive">
                    <i class="fa-solid fa-image"></i> OpenAI Image
                </div>
                <div onclick="switchModel('img-sd')" class="sidebar-item sidebar-inactive">
                    <i class="fa-solid fa-palette"></i> Stablediffusion
                </div>
            </nav>

            <div class="p-4 border-t border-white/10">
                <button onclick="logout()" class="w-full text-left text-sm text-red-400 flex items-center gap-2 hover:text-red-300 transition p-2 rounded-lg hover:bg-white/5">
                    <i class="fa-solid fa-sign-out-alt"></i> Keluar
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full relative w-full">
            
            <header class="h-14 flex items-center px-4 md:hidden justify-between shrink-0 border-b border-white/5">
                <button onclick="toggleSidebar()" class="text-gray-400"><i class="fa-solid fa-bars text-xl"></i></button>
                <span id="mobileHeaderTitle" class="font-bold">Gemini</span>
                <div class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 text-center leading-8 font-bold text-xs text-white shadow-lg">U</div>
            </header>

            <div id="scrollContainer" class="flex-1 overflow-y-auto p-4 flex flex-col items-center">
                
                <div id="welcomeScreen" class="w-full max-w-3xl mt-8 md:mt-16 animate-[fadeIn_0.5s]">
                    <div class="mb-10">
                        <h1 class="text-4xl md:text-5xl font-medium mb-2"><span id="welcomeTitle" class="gradient-text">Halo</span></h1>
                        <h2 id="welcomeSubtitle" class="text-3xl md:text-4xl font-medium opacity-60">Ada yang bisa saya bantu?</h2>
                    </div>
                    
                    <div id="suggestionGrid" class="grid grid-cols-1 md:grid-cols-2 gap-3 w-full">
                        </div>
                </div>

                <div id="chatContainer" class="w-full max-w-3xl flex flex-col gap-6 hidden pb-32 pt-4">
                </div>

                <div id="imageResultContainer" class="hidden w-full max-w-2xl flex flex-col items-center mt-10">
                    <div id="imgLoader" class="hidden text-center">
                        <div class="gemini-loader w-64 mb-4"></div>
                        <p class="opacity-70 animate-pulse">Sedang memproses gambar...</p>
                    </div>
                    <img id="generatedImage" class="hidden rounded-lg shadow-2xl border border-gray-600 w-full">
                    <a id="dlBtn" class="hidden mt-6 bg-blue-600 text-white px-6 py-2 rounded-full font-bold hover:bg-blue-700 transition shadow-lg">Download Gambar</a>
                </div>
            </div>

            <div class="w-full p-4 flex justify-center shrink-0">
                <div class="w-full max-w-3xl relative">
                    
                    <div id="filePreview" class="hidden absolute -top-12 left-0 bg-[#1e1f20] px-4 py-2 rounded-t-lg border border-gray-600 border-b-0 flex items-center gap-2 shadow-lg">
                        <i class="fa-solid fa-file-arrow-up text-blue-400"></i>
                        <span id="fileName" class="text-xs text-gray-300 truncate max-w-[150px]">file</span>
                        <button onclick="clearFile()" class="text-red-400 hover:text-red-300 ml-2"><i class="fa-solid fa-times"></i></button>
                    </div>

                    <div class="input-box flex items-center px-3 py-2 transition-all duration-300">
                        <div id="uploadBtnWrapper" class="hidden mr-2">
                            <label for="fileInput" class="w-9 h-9 flex items-center justify-center rounded-full hover:bg-white/10 cursor-pointer transition" title="Upload Semua Jenis File">
                                <i class="fa-solid fa-plus text-lg opacity-70"></i>
                            </label>
                            <input type="file" id="fileInput" class="hidden" onchange="handleFileSelect(this)">
                        </div>

                        <textarea id="promptInput" rows="1" placeholder="Ketik pesan..." class="flex-1 bg-transparent border-none outline-none px-2 py-3 max-h-40 resize-none placeholder-opacity-50"></textarea>

                        <button onclick="sendRequest()" id="sendBtn" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/10 transition ml-2">
                            <i class="fa-solid fa-paper-plane"></i>
                        </button>
                    </div>
                    <p class="text-center text-[10px] opacity-50 mt-2">Xayz AI dapat membuat kesalahan. Cek informasi penting.</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        let currentModel = 'gemini';
        let currentUser = null;
        let isGenerating = false;
        let selectedFile = null;
        let abortController = null;

        // --- AUTH HANDLERS ---
        async function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('loginUser').value;
            const p = document.getElementById('loginPass').value;
            const btn = e.target.querySelector('button');
            const oldText = btn.innerText;
            btn.innerText = "Loading...";
            
            try {
                const res = await fetch('/api/login', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username: u, password: p, remember: true })
                });
                const data = await res.json();
                if(data.success) initApp(data.user); 
                else alert(data.error);
            } catch(e){ alert("Koneksi gagal"); }
            btn.innerText = oldText;
        }

        async function handleRegister(e) {
            e.preventDefault();
            const u = document.getElementById('regUser').value;
            const p = document.getElementById('regPass').value;
            const f = document.getElementById('regFirst').value;
            const l = document.getElementById('regLast').value;
            try {
                const res = await fetch('/api/register', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username: u, password: p, firstName: f, lastName: l })
                });
                const data = await res.json();
                if(data.message) { alert("Registrasi berhasil. Silakan Login."); toggleAuth('login'); }
                else alert(data.error);
            } catch(e) { alert("Error"); }
        }

        function toggleAuth(page) {
            // FIX LOGIC: Simply toggle hidden classes on the forms themselves
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            
            if(page === 'register') {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
            } else {
                registerForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
            }
        }

        function initApp(user) {
            currentUser = user;
            document.getElementById('authPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            switchModel('gemini');
        }

        // --- THEME & MODEL SWITCHING ---
        function switchModel(model) {
            if (abortController) abortController.abort();
            abortController = new AbortController();
            currentModel = model;

            // Update Class Body (Reset dulu)
            document.body.className = 'h-[100dvh] w-full overflow-hidden flex flex-col'; 
            
            // Set Theme Class
            if (model === 'gemini') document.body.classList.add('theme-gemini');
            else if (model === 'chatgpt') document.body.classList.add('theme-chatgpt');
            else if (model === 'bing') document.body.classList.add('theme-bing');
            else if (model === 'blackbox') document.body.classList.add('theme-blackbox');
            else document.body.classList.add('theme-gemini'); 

            // Sidebar UI
            document.querySelectorAll('.sidebar-item').forEach(el => {
                el.classList.remove('sidebar-active');
                el.classList.add('sidebar-inactive');
            });
            event.currentTarget.classList.remove('sidebar-inactive');
            event.currentTarget.classList.add('sidebar-active');

            // Reset Chat View
            document.getElementById('chatContainer').innerHTML = '';
            document.getElementById('welcomeScreen').classList.remove('hidden');
            document.getElementById('chatContainer').classList.add('hidden');
            document.getElementById('imageResultContainer').classList.add('hidden');
            document.getElementById('mobileHeaderTitle').innerText = model.toUpperCase();

            // Setup Specific UI Elements
            const upWrapper = document.getElementById('uploadBtnWrapper');
            const welcomeTitle = document.getElementById('welcomeTitle');
            const welcomeSub = document.getElementById('welcomeSubtitle');
            
            let userName = currentUser ? currentUser.firstName : 'Pengguna';

            if (model === 'gemini') {
                upWrapper.classList.remove('hidden'); 
                welcomeTitle.innerHTML = `Halo, <span class="gradient-text">${userName}</span>`;
                welcomeTitle.className = '';
                welcomeSub.innerText = 'Ada yang bisa saya bantu?';
                renderSuggestions('gemini');
            } else if (model === 'chatgpt') {
                upWrapper.classList.add('hidden'); 
                welcomeTitle.innerHTML = `Halo, ${userName}`;
                welcomeTitle.className = '';
                welcomeSub.innerText = 'Apa yang ingin Anda tanyakan?';
                renderSuggestions('text');
            } else if (model === 'bing') {
                upWrapper.classList.add('hidden');
                welcomeTitle.innerHTML = `Halo, ${userName}`;
                welcomeTitle.className = 'gradient-text';
                welcomeSub.innerText = 'Mari menjelajahi web bersama.';
                renderSuggestions('search');
            } else if (model === 'blackbox') {
                upWrapper.classList.add('hidden');
                welcomeTitle.innerHTML = `Halo, ${userName}`;
                welcomeTitle.className = 'gradient-text';
                welcomeSub.innerText = '// Siap coding hari ini?';
                renderSuggestions('code');
            } else {
                upWrapper.classList.add('hidden');
                welcomeTitle.innerHTML = `Halo, ${userName}`;
                welcomeTitle.className = '';
                welcomeSub.innerText = 'Deskripsikan imajinasimu.';
                renderSuggestions('image');
            }
            clearFile();
            if(window.innerWidth < 768) toggleSidebar();
        }

        // --- SUGGESTIONS ---
        function renderSuggestions(type) {
            const grid = document.getElementById('suggestionGrid');
            grid.innerHTML = '';
            
            const suggestions = {
                gemini: [
                    { t: 'Buatkan rencana liburan ke Bali', i: 'fa-plane' },
                    { t: 'Analisis file ini', i: 'fa-file' }, 
                    { t: 'Tulis puisi tentang hujan', i: 'fa-pen-nib' },
                    { t: 'Tips belajar bahasa asing', i: 'fa-language' }
                ],
                text: [
                    { t: 'Jelaskan komputasi kuantum', i: 'fa-atom' },
                    { t: 'Buatkan email formal', i: 'fa-envelope' },
                    { t: 'Ringkas artikel ini', i: 'fa-file-lines' },
                    { t: 'Ide konten YouTube', i: 'fa-lightbulb' }
                ],
                search: [
                    { t: 'Berita terkini hari ini', i: 'fa-newspaper' },
                    { t: 'Resep masakan padang', i: 'fa-utensils' },
                    { t: 'Harga tiket pesawat', i: 'fa-ticket' },
                    { t: 'Cuaca di Jakarta', i: 'fa-cloud' }
                ],
                code: [
                    { t: 'Buat kalkulator Python', i: 'fa-calculator' },
                    { t: 'Jelaskan React Hooks', i: 'fa-brands fa-react' },
                    { t: 'Fix bug kode ini', i: 'fa-bug' },
                    { t: 'Query SQL untuk user', i: 'fa-database' }
                ],
                image: [
                    { t: 'Kucing astronot di bulan', i: 'fa-cat' },
                    { t: 'Kota cyberpunk malam hari', i: 'fa-city' },
                    { t: 'Lukisan pemandangan gunung', i: 'fa-mountain' },
                    { t: 'Logo perusahaan teknologi', i: 'fa-shapes' }
                ]
            };

            const selected = suggestions[type] || suggestions.gemini;
            
            selected.forEach(s => {
                const div = document.createElement('div');
                div.className = 'suggestion-card p-4 flex flex-col justify-between h-32 cursor-pointer transition';
                div.onclick = () => handleSuggestionClick(s.t);
                div.innerHTML = `
                    <span class="text-sm opacity-90 font-medium">${s.t}</span>
                    <div class="self-end p-2 bg-white/5 rounded-full"><i class="fa-solid ${s.i}"></i></div>
                `;
                grid.appendChild(div);
            });
        }

        function handleSuggestionClick(text) {
            document.getElementById('promptInput').value = text;
            if (!currentModel.startsWith('img-')) sendRequest();
        }

        // --- CHAT LOGIC ---
        function appendUserMessage(text) {
            const c = document.getElementById('chatContainer');
            const div = document.createElement('div');
            div.className = 'user-msg p-3 text-sm self-end max-w-[85%] mb-4 shadow-sm';
            div.innerText = text;
            c.appendChild(div);
        }

        function appendAIMessage(htmlContent) {
            const c = document.getElementById('chatContainer');
            const wrapper = document.createElement('div');
            wrapper.className = 'w-full flex gap-3 animate-[fadeIn_0.3s] mb-6';
            
            let icon = 'fa-star';
            if(currentModel==='chatgpt') icon='fa-bolt';
            if(currentModel==='blackbox') icon='fa-code';
            if(currentModel==='bing') icon='fa-brands fa-microsoft';
            
            wrapper.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-600 to-purple-600 flex items-center justify-center shrink-0 h-max shadow-md">
                    <i class="fa-solid ${icon} text-white text-xs"></i>
                </div>
                <div class="ai-msg flex-1 text-sm overflow-hidden leading-relaxed">
                    ${htmlContent}
                </div>
            `;
            c.appendChild(wrapper);
            
            // Add Copy Buttons
            wrapper.querySelectorAll('pre').forEach(pre => {
                const code = pre.querySelector('code').innerText;
                const header = document.createElement('div');
                header.className = 'code-header';
                header.innerHTML = `<span>Code</span><button class="copy-btn" onclick="copyToClipboard(this, \`${encodeURIComponent(code)}\`)"><i class="fa-regular fa-copy"></i> Salin</button>`;
                pre.insertBefore(header, pre.firstChild);
            });

            document.getElementById('scrollContainer').scrollTop = document.getElementById('scrollContainer').scrollHeight;
        }

        function copyToClipboard(btn, encodedCode) {
            const code = decodeURIComponent(encodedCode);
            navigator.clipboard.writeText(code).then(() => {
                btn.innerHTML = '<i class="fa-solid fa-check"></i> Disalin';
                setTimeout(() => btn.innerHTML = '<i class="fa-regular fa-copy"></i> Salin', 2000);
            });
        }

        async function sendRequest() {
            if(isGenerating) return;
            const input = document.getElementById('promptInput');
            const text = input.value.trim();
            if(!text && !selectedFile) return;

            isGenerating = true;
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('chatContainer').classList.remove('hidden');

            if(currentModel.startsWith('img-')) {
                document.getElementById('chatContainer').classList.add('hidden');
                document.getElementById('imageResultContainer').classList.remove('hidden');
                document.getElementById('imgLoader').classList.remove('hidden');
                document.getElementById('generatedImage').classList.add('hidden');
                document.getElementById('dlBtn').classList.add('hidden');
            } else {
                appendUserMessage(text);
            }
            
            input.value = '';
            const loadingId = 'loading-' + Date.now();
            
            if(!currentModel.startsWith('img-')) {
                const c = document.getElementById('chatContainer');
                const ld = document.createElement('div');
                ld.id = loadingId;
                ld.className = 'ml-11 gemini-loader w-24 mb-4';
                c.appendChild(ld);
            }

            try {
                const reqModel = currentModel;
                let endpoint = currentModel === 'gemini' ? '/api/gemini' : '/api/chat';
                
                if(currentModel.startsWith('img-')) {
                    const res = await fetch('/api/image', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ prompt: text, model: currentModel === 'img-openai' ? 'openai' : 'stablediffusion' }),
                        signal: abortController.signal
                    });
                    const data = await res.json();
                    if(currentModel !== reqModel) return;
                    document.getElementById('imgLoader').classList.add('hidden');
                    document.getElementById('generatedImage').src = data.imageUrl;
                    document.getElementById('generatedImage').classList.remove('hidden');
                    document.getElementById('dlBtn').classList.remove('hidden');
                    document.getElementById('dlBtn').href = data.imageUrl;
                    document.getElementById('dlBtn').download = "ai-image.jpg";
                } else {
                    let res;
                    if(currentModel === 'gemini') {
                        const fd = new FormData();
                        fd.append('message', text);
                        if(selectedFile) fd.append('file', selectedFile);
                        res = await fetch(endpoint, { method: 'POST', body: fd, signal: abortController.signal });
                    } else {
                        res = await fetch(endpoint, {
                            method: 'POST', headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ message: text, model: currentModel }),
                            signal: abortController.signal
                        });
                    }
                    const data = await res.json();
                    if(currentModel !== reqModel) return;
                    if(document.getElementById(loadingId)) document.getElementById(loadingId).remove();
                    clearFile();
                    appendAIMessage(marked.parse(data.reply));
                }
            } catch(e) {
                if(e.name !== 'AbortError') {
                   if(document.getElementById(loadingId)) document.getElementById(loadingId).remove();
                }
            }
            isGenerating = false;
        }

        function handleFileSelect(input) {
            if(input.files && input.files[0]) {
                selectedFile = input.files[0];
                document.getElementById('filePreview').classList.remove('hidden');
                document.getElementById('fileName').innerText = selectedFile.name;
            }
        }
        function clearFile() {
            selectedFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('filePreview').classList.add('hidden');
        }
        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('sidebarOverlay');
            sb.classList.toggle('-translate-x-full');
            ov.classList.toggle('hidden');
        }
        async function logout() { await fetch('/api/logout', {method:'POST'}); window.location.reload(); }
        
        const tx = document.getElementById('promptInput');
        tx.addEventListener("input", function(){ this.style.height="auto"; this.style.height=(this.scrollHeight)+"px"; });
        
        // Check Session
        fetch('/api/me').then(r=>r.json()).then(d=>{ if(d.loggedIn) initApp(d.user); });

    </script>
</body>
</html>
